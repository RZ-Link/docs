---
outline: deep
---

# 虚拟化

## 安装虚拟化组件

安装qemu组件
```shell
yum install -y qemu
```

安装libvirt组件
```shell
yum install -y libvirt
```

解决权限问题
```shell
vi /etc/libvirt/qemu.conf

#user = "qemu"
#group = "qemu"
user = "root"
group = "root"
```

启动libvirtd服务
```shell
systemctl start libvirtd
```

查看内核是否支持KVM虚拟化，查看/dev/kvm和/sys/module/kvm文件是否存在，文件存在，说明内核支持KVM虚拟化
```shell
ls /dev/kvm
ls /sys/module/kvm
```

安装bridge-utils软件包
```shell
yum install -y bridge-utils
```

安装virt-install软件包
```shell
yum install -y virt-install
```

## 相同服务器的虚拟机互相访问

服务器1创建网桥br0
```shell
brctl addbr br0
ip link set dev br0 up
```

服务器1创建、启动虚拟机1，设置静态IP为10.0.0.10，子网掩码为255.255.255.0
```shell
qemu-img create -f qcow2 openEuler1.qcow2 10G
virt-install --virt-type kvm --name openEuler1 --ram 2048 --disk openEuler1.qcow2,format=qcow2 --network bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=unknown --location=openEuler-24.03-LTS-x86_64-dvd.iso
```

服务器1创建、启动虚拟机2，设置静态IP为10.0.0.20，子网掩码为255.255.255.0
```shell
qemu-img create -f qcow2 openEuler2.qcow2 10G
virt-install --virt-type kvm --name openEuler2 --ram 2048 --disk openEuler2.qcow2,format=qcow2 --network bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=unknown --location=openEuler-24.03-LTS-x86_64-dvd.iso
```

虚拟机1访问虚拟机2
```shell
ping 10.0.0.20
```

虚拟机2访问虚拟机1
```shell
ping 10.0.0.10
```

## 不同服务器的虚拟机互相访问

服务器2创建网桥br0
```shell
brctl addbr br0
ip link set dev br0 up
```

服务器2创建、启动虚拟机3，设置静态IP为10.0.0.30，子网掩码为255.255.255.0
```shell
qemu-img create -f qcow2 openEuler3.qcow2 10G
virt-install --virt-type kvm --name openEuler3 --ram 2048 --disk openEuler3.qcow2,format=qcow2 --network bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=unknown --location=openEuler-24.03-LTS-x86_64-dvd.iso
```

服务器1创建vxlan0，将vxlan添加到br0
```shell
ip link add vxlan0 type vxlan id 42 group 239.1.1.1 dev ens33 dstport 4789
ip link set dev vxlan0 up
ip link set vxlan0 master br0
```

服务器2创建vxlan0，将vxlan添加到br0
```shell
ip link add vxlan0 type vxlan id 42 group 239.1.1.1 dev ens33 dstport 4789
ip link set dev vxlan0 up
ip link set vxlan0 master br0
```

虚拟机1访问虚拟机3
```shell
ping 10.0.0.30
```

虚拟机3访问虚拟机1
```shell
ping 10.0.0.10
```