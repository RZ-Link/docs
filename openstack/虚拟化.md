---
outline: deep
---

# 虚拟化

## 安装虚拟化组件

安装qemu组件
```shell
yum install -y qemu
```

安装libvirt组件
```shell
yum install -y libvirt
```

解决权限问题
```shell
vi /etc/libvirt/qemu.conf

#user = "qemu"
#group = "qemu"
user = "root"
group = "root"
```

启动libvirtd服务
```shell
systemctl start libvirtd
```

查看内核是否支持KVM虚拟化，查看/dev/kvm和/sys/module/kvm文件是否存在。文件存在，说明内核支持KVM虚拟化
```shell
ls /dev/kvm
ls /sys/module/kvm
```

安装bridge-utils软件包
```shell
yum install -y bridge-utils
```

安装virt-install软件包
```shell
yum install -y virt-install
```

## 相同服务器的虚拟机互相访问

服务器1创建网桥br0
```shell
brctl addbr br0
ip link set dev br0 up
```

服务器1启动虚拟机1，设置静态IP为10.0.0.10，子网掩码为255.255.255.0
```shell
virt-install --virt-type kvm --name cirros1 --ram 512 --disk cirros1.img,format=qcow2 --network bridge=br0,model=virtio --console pty,target_type=serial --noautoconsole --os-type=linux --os-variant=unknown --import
```

服务器1启动虚拟机2，设置静态IP为10.0.0.20，子网掩码为255.255.255.0
```shell
virt-install --virt-type kvm --name cirros2 --ram 512 --disk cirros2.img,format=qcow2 --network bridge=br0,model=virtio --console pty,target_type=serial --noautoconsole --os-type=linux --os-variant=unknown --import
```

虚拟机1访问虚拟机2
```shell
ping 10.0.0.20
```

虚拟机2访问虚拟机1
```shell
ping 10.0.0.10
```

## 不同服务器的虚拟机互相访问

服务器2创建网桥br0
```shell
brctl addbr br0
ip link set dev br0 up
```

服务器2启动虚拟机3，设置静态IP为10.0.0.30，子网掩码为255.255.255.0
```shell
virt-install --virt-type kvm --name cirros3 --ram 512 --disk cirros3.img,format=qcow2 --network bridge=br0,model=virtio --console pty,target_type=serial --noautoconsole --os-type=linux --os-variant=unknown --import
```

服务器1创建vxlan0，将vxlan0添加到br0
```shell
ip link add vxlan0 type vxlan id 42 group 239.1.1.1 dev ens33 dstport 4789
ip link set dev vxlan0 up
ip link set vxlan0 master br0
```

服务器2创建vxlan0，将vxlan0添加到br0
```shell
ip link add vxlan0 type vxlan id 42 group 239.1.1.1 dev ens33 dstport 4789
ip link set dev vxlan0 up
ip link set vxlan0 master br0
```

虚拟机1访问虚拟机3
```shell
ping 10.0.0.30
```

虚拟机3访问虚拟机1
```shell
ping 10.0.0.10
```

## 命令参考

查询主机上已经定义的所有虚拟机信息列表
```shell
virsh list --all
```

导入启动虚拟机
```shell
virt-install --virt-type kvm --name openEuler1 --ram 2048 --disk openEuler-24.03-LTS-x86_64.qcow2,format=qcow2 --network bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=unknown --import
virt-install --virt-type kvm --name cirros1 --ram 512 --disk cirros-0.6.3-x86_64-disk.img,format=qcow2 --network bridge=br0,model=virtio --console pty,target_type=serial --noautoconsole --os-type=linux --os-variant=unknown --import
```

启动虚拟机
```shell
virsh start <VMInstance>
```

关闭虚拟机
```shell
virsh shutdown <VMInstance>
```

销毁虚拟机
```shell
virsh undefine <VMInstance>
```

查询虚拟机使用的VNC端口号
```shell
virsh vncdisplay <VMInstance>
```

连接虚拟机串口
```shell
virsh console <VMInstance>
```

## Create images manually

Before starting a virtual machine with libvirt, verify that the libvirt default network has started.
```shell
virsh net-list
```

The following example shows how to use the qemu-img command to create an empty image file, and virt-install command to start up a virtual machine using that image file.
```shell
qemu-img create -f qcow2 openEuler1.qcow2 10G
virt-install --virt-type kvm --name openEuler1 --ram 2048 --disk openEuler1.qcow2,format=qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=unknown --location=openEuler-24.03-LTS-x86_64-dvd.iso
```
